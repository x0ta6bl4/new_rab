# Многоботовая система для Telegram

## Использование Docker

Проект настроен для запуска в Docker-контейнере, что обеспечивает изоляцию зависимостей и упрощает развертывание.

### Предварительные требования

- Установленный Docker
- Установленный Docker Compose
- Файл `keys.env` с необходимыми API-ключами в родительской директории проекта

### Локальный запуск с использованием Docker

1. Клонируйте репозиторий:
   ```bash
   git clone <url-репозитория>
   cd project
   ```

2. Создайте файл `keys.env` в родительской директории проекта со следующим содержимым:
   ```
   TELEGRAM_BOT_TOKEN=ваш_токен_от_botfather
   OPENAI_API_KEY=ваш_ключ_openai
   ```

3. Соберите и запустите контейнеры:
   ```bash
   docker-compose build
   docker-compose up -d
   ```

4. Проверьте статус контейнеров:
   ```bash
   docker-compose ps
   ```

5. Для просмотра логов:
   ```bash
   docker-compose logs -f
   ```

6. Для остановки контейнеров:
   ```bash
   docker-compose down
   ```

## Деплой на сервер

Для деплоя проекта на сервер можно использовать один из предоставленных скриптов или настроить автоматический деплой.

### Деплой с использованием PowerShell (Windows)

1. Отредактируйте файл `deploy.ps1`, указав правильные данные для подключения к серверу:
   ```powershell
   $SERVER_USER = "ваш_пользователь"
   $SERVER_HOST = "ваш_хост"
   $SERVER_PATH = "/путь/на/сервере"
   ```

2. Запустите скрипт деплоя:
   ```powershell
   ./deploy.ps1
   ```

### Деплой с использованием Bash (Linux/Mac)

1. Отредактируйте файл `deploy.sh`, указав правильные данные для подключения к серверу:
   ```bash
   SERVER_USER="ваш_пользователь"
   SERVER_HOST="ваш_хост"
   SERVER_PATH="/путь/на/сервере"
   ```

2. Сделайте скрипт исполняемым и запустите его:
   ```bash
   chmod +x deploy.sh
   ./deploy.sh
   ```

### Автоматический деплой

Проект поддерживает автоматический деплой при изменениях в репозитории. Доступны следующие методы:

#### GitHub Actions

Для настройки автоматического деплоя через GitHub Actions:

1. Убедитесь, что файл `.github/workflows/auto_deploy.yml` присутствует в вашем репозитории.
2. В настройках репозитория GitHub добавьте следующие секреты:
   - `SSH_PRIVATE_KEY`: приватный SSH-ключ для подключения к серверу
   - `SERVER_HOST`: IP-адрес или домен сервера
   - `SERVER_USER`: имя пользователя для SSH-подключения
   - `SERVER_PATH`: путь к директории проекта на сервере

#### GitLab CI/CD

Для настройки автоматического деплоя через GitLab CI/CD:

1. Убедитесь, что файл `.gitlab-ci.yml` присутствует в вашем репозитории.
2. В настройках проекта GitLab добавьте следующие переменные:
   - `SSH_PRIVATE_KEY`: приватный SSH-ключ для подключения к серверу
   - `SSH_KNOWN_HOSTS`: содержимое файла known_hosts для SSH
   - `SERVER_HOST`: IP-адрес или домен сервера
   - `SERVER_USER`: имя пользователя для SSH-подключения
   - `SERVER_PATH`: путь к директории проекта на сервере

#### Webhook

Для настройки webhook на сервере:

1. Для Linux-сервера используйте скрипт `scripts/setup_webhook.sh`:
   ```bash
   chmod +x scripts/setup_webhook.sh
   sudo ./scripts/setup_webhook.sh
   ```

2. Для Windows-сервера используйте скрипт `scripts/setup_webhook.ps1`:
   ```powershell
   ./scripts/setup_webhook.ps1
   ```

Подробные инструкции по настройке автоматического деплоя доступны в файле `docs/auto_deploy_setup.md`.

## Структура проекта в Docker

- **Dockerfile**: Определяет образ Docker для приложения
- **docker-compose.yml**: Настраивает сервисы, тома и переменные окружения
- **deploy.sh/deploy.ps1**: Скрипты для автоматического деплоя на сервер

## Тома (volumes)

- **keys.env**: Монтируется как файл только для чтения
- **data**: Директория для хранения данных базы данных
- **/tmp/telegram_bot_voice**: Директория для временных голосовых файлов

## Примечания

- Контейнер настроен на автоматический перезапуск при сбоях (`restart: unless-stopped`)
- Логи ротируются с максимальным размером 10MB и хранением до 3 файлов
- Временная зона установлена на Europe/Moscow (можно изменить в docker-compose.yml)